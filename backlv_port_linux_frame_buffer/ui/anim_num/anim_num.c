#include"anim_num.h"
const uint16_t num_dot[11][2*DOT_NUM]={
    { 0x00bf,0x0001,0x0025,0x0001,0x0008,0x001e,0x0000,0x0046,0x0000,0x02ff,0x0017,0x031f,0x002d,0x032f,0x0160,0x032f,0x017d,0x0321,0x0191,0x0304,0x0191,0x0025,0x0179,0x000b,0x0150,0x0000,0x00d3,0x0000,0x00d3,0x0069,0x011a,0x0069,0x011a,0x02c8,0x0079,0x02c8,0x0079,0x0067,0x00bf,0x0067 },
    //{ 0x00a6,0x0000,0x0042,0x0000,0x0000,0x00db,0x0000,0x00ed,0x0030,0x00ed,0x0030,0x012e,0x0030,0x0221,0x0030,0x032d,0x0070,0x032d,0x00a6,0x032d,0x00a6,0x02f4,0x00a6,0x02a8,0x00a6,0x0257,0x00a6,0x0206,0x00a6,0x01b7,0x00a6,0x0155,0x00a6,0x0108,0x00a6,0x00bd,0x00a6,0x0075,0x00a6,0x003d },
    { 0x0113,0x0000,0x00af,0x0000,0x006d,0x00db,0x006d,0x00ed,0x009d,0x00ed,0x009d,0x012e,0x009d,0x0221,0x009d,0x032d,0x00dd,0x032d,0x0113,0x032d,0x0113,0x02f4,0x0113,0x02a8,0x0113,0x0257,0x0113,0x0206,0x0113,0x01b7,0x0113,0x0155,0x0113,0x0108,0x0113,0x00bd,0x0113,0x0075,0x0113,0x003d },
    { 0x003b,0x0000,0x001e,0x000e,0x000b,0x0027,0x000a,0x00ff,0x007f,0x00ff,0x0080,0x0066,0x0116,0x0066,0x0116,0x00fb,0x0000,0x02e3,0x0000,0x0330,0x0070,0x0330,0x00c5,0x0330,0x011b,0x0330,0x018e,0x0330,0x018e,0x02c6,0x0092,0x02c6,0x018d,0x0109,0x018d,0x002f,0x017b,0x000f,0x0157,0x0000 },
    { 0x0001,0x0100,0x0079,0x0100,0x0079,0x006c,0x0113,0x006c,0x0114,0x0118,0x0081,0x017a,0x0081,0x0196,0x0116,0x01fe,0x0116,0x02c9,0x0079,0x02c9,0x0079,0x022c,0x0000,0x022c,0x0000,0x0331,0x018b,0x0332,0x018d,0x01d9,0x0119,0x0187,0x018b,0x013b,0x0188,0x0002,0x00c6,0x0000,0x0002,0x0001 },
    { 0x010b,0x022f,0x0087,0x022f,0x00c1,0x0185,0x00fa,0x00e1,0x0146,0x0001,0x00c8,0x0000,0x0077,0x00f1,0x003e,0x0196,0x0000,0x024a,0x0000,0x0294,0x010c,0x0294,0x010c,0x032d,0x014d,0x032d,0x0180,0x032d,0x0180,0x0295,0x01bd,0x0295,0x01bd,0x022c,0x017d,0x022c,0x017e,0x0138,0x010b,0x0138 },
    { 0x0152,0x0125,0x0078,0x0123,0x0080,0x0068,0x017f,0x006b,0x017f,0x0000,0x0011,0x0000,0x0001,0x018d,0x0110,0x018b,0x0110,0x02c7,0x0077,0x02c7,0x0077,0x0229,0x0000,0x0229,0x0000,0x02fa,0x000f,0x031c,0x0037,0x0330,0x0154,0x032f,0x017a,0x031c,0x0189,0x02f0,0x0187,0x0162,0x0179,0x0137 },
    { 0x018b,0x015d,0x0077,0x015d,0x0076,0x0067,0x0113,0x0067,0x0113,0x00f6,0x0187,0x00f6,0x0187,0x0020,0x015f,0x0000,0x0022,0x0000,0x0000,0x0026,0x0001,0x032d,0x00be,0x032d,0x00be,0x02c3,0x0078,0x02c3,0x0078,0x01c1,0x0117,0x01c1,0x0117,0x02c4,0x00de,0x02c4,0x00de,0x032c,0x018b,0x032c },
    { 0x0100,0x0288,0x0118,0x022b,0x0130,0x01c9,0x014a,0x0162,0x0160,0x0105,0x017b,0x00a2,0x0192,0x004f,0x0193,0x0000,0x00c0,0x0000,0x0000,0x0000,0x0000,0x00db,0x0073,0x00db,0x0073,0x0062,0x0112,0x0062,0x00e1,0x0127,0x00ae,0x01de,0x0085,0x027c,0x0059,0x032f,0x00d7,0x032f,0x00ec,0x02d8 },
    { 0x0118,0x012c,0x0000,0x01c0,0x0000,0x032f,0x0192,0x032f,0x0192,0x01c4,0x007a,0x012b,0x007a,0x0065,0x00be,0x0065,0x00be,0x0000,0x0003,0x0000,0x0003,0x014d,0x011b,0x01e6,0x011b,0x02ca,0x0076,0x02ca,0x0076,0x01e6,0x018f,0x0150,0x018f,0x0000,0x00da,0x0000,0x00da,0x0066,0x0118,0x0066 },
    { 0x0113,0x016d,0x0077,0x016d,0x0077,0x0069,0x00c0,0x0069,0x00c0,0x0000,0x0000,0x0000,0x0000,0x01d0,0x0113,0x01d0,0x0113,0x02cb,0x007b,0x02cb,0x007b,0x023c,0x0006,0x023c,0x0006,0x030f,0x0028,0x032f,0x0167,0x032f,0x018d,0x0307,0x018d,0x0002,0x00d7,0x0002,0x00d7,0x0067,0x0113,0x0067 },
    { 0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6,0x00ce,0x01a6 }
};//0-9坐标表，最后一行是归位

struct anim_num** anim_list=NULL;//记录对应指针，为了给回调函数查表
unsigned int anim_list_cnt=0;//表长




void num_tran_cb(lv_obj_t *anim_obj,unsigned char step)
{
    lv_point_t* tmp_dot=NULL;
    uint8_t pre_num=0;
    uint8_t now_num=0;
    uint8_t time=0;

    for(unsigned char i=0;i<anim_list_cnt;i++)
    {
        if(anim_list[i]->obj==anim_obj)
        {
            tmp_dot=anim_list[i]->dot;
            pre_num=anim_list[i]->pre_num;
            now_num=anim_list[i]->now_num;
            time=anim_list[i]->time;
            for(unsigned char i=0;i<DOT_NUM;i++)
            {
                tmp_dot[i].x =(num_dot[pre_num][2*i]*255-num_dot[pre_num][2*i]*step+num_dot[now_num][2*i]*step)/255/time;
                tmp_dot[i].y =(num_dot[pre_num][2*i+1]*255-num_dot[pre_num][2*i+1]*step+num_dot[now_num][2*i+1]*step)/255/time;        
            }     
            tmp_dot[DOT_NUM]=tmp_dot[0];
            lv_line_set_points(anim_obj,tmp_dot,DOT_NUM+1);  
            return; 
        }
    }
}


struct anim_num*  anim_num_create (lv_obj_t* par,int x,int y,unsigned char time,lv_color_t col,unsigned char wid)//创建一个数字，返回为该对象的编号
{
    struct anim_num* res=NULL;
    res=(struct anim_num*)calloc(1,sizeof(struct anim_num));
    res->dot = (lv_point_t*)malloc(sizeof(lv_point_t)*(DOT_NUM+1));
    res->obj=lv_line_create(par);
    lv_obj_set_pos(res->obj,x,y);
    lv_style_init(&(res->style_line));
    lv_style_set_line_width(&(res->style_line), wid);
    lv_style_set_line_color(&(res->style_line), col);
    lv_style_set_line_rounded(&(res->style_line), true);
    lv_obj_add_style(res->obj,&(res->style_line),0);

    res->pre_num=res->now_num=10;

    res->time=time;

    anim_list_cnt++;
    struct anim_num** t_anim_list=(struct anim_num**)calloc(anim_list_cnt,sizeof(struct anim_num*));  
    for(unsigned int i=0;i<anim_list_cnt-1;i++)
    {
        t_anim_list[i]=anim_list[i];
    }  
    t_anim_list[anim_list_cnt-1]=res;
    if(anim_list_cnt>1)free(anim_list);
    anim_list=t_anim_list;


    return res;
}
void anim_num_del(struct anim_num* del_obj)
{
    lv_obj_del(del_obj->obj); 
    free(del_obj->dot);
    lv_style_reset(&(del_obj->style_line));


    anim_list_cnt--;
    if(anim_list_cnt==0)
    {
        free(anim_list);
        anim_list=NULL;
    }
    else
    {
        struct anim_num** t_anim_list=(struct anim_num**)calloc(anim_list_cnt,sizeof(struct anim_num*)); 
        unsigned int j=0; 
        for(unsigned int i=0;i<anim_list_cnt+1;i++)
        {
            if(anim_list[i]!=del_obj)
            {
                t_anim_list[j]=anim_list[i];
                j++;            
            }

        }
        free(anim_list);  
        anim_list=t_anim_list; 
    }

}

void anim_num_disp(struct anim_num* anim_obj,unsigned char num,unsigned int t)//改变显示数字。数字(10为归位)与动画时长
{
    anim_obj->pre_num=anim_obj->now_num;
    anim_obj->now_num=num;
    lv_anim_t a;
    lv_anim_init(&a);
    lv_anim_set_exec_cb(&a, (lv_anim_exec_xcb_t)num_tran_cb);
    lv_anim_set_var(&a, anim_obj->obj);
    lv_anim_set_time(&a, t);
    lv_anim_set_values(&a, 0, 255);
    lv_anim_set_path_cb(&a, lv_anim_path_ease_out);
    lv_anim_set_early_apply(&a, true);
    lv_anim_start(&a);                 /* 应用动画效果 */    
}



